<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ì¹˜ ì €ì¥ ë° ì§€ë„ í™•ì¸</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; text-align: center; padding: 20px; color: #333; }
        
        button {
            padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 8px;
            background-color: #4285F4; color: white; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #3367D6; }

        #status { margin: 20px 0; color: #666; font-size: 0.9em; }

        /* ê²°ê³¼ ì£¼ì†Œ ìŠ¤íƒ€ì¼ (ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì»¤ì„œ ë³€ê²½) */
        #result-container { margin-top: 30px; display: none; }
        .address-text {
            font-size: 1.4em; font-weight: bold; color: #2c3e50;
            text-decoration: underline; text-decoration-style: dotted;
            cursor: help; position: relative; display: inline-block;
        }

        /* íŒì—… ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map-tooltip {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: absolute;
            width: 300px; height: 200px;
            top: 100%; left: 50%;
            transform: translateX(-50%);
            border: 2px solid #4285F4; border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            margin-top: 10px;
            background: white;
        }
        
        /* íˆ´íŒ í™”ì‚´í‘œ */
        #map-tooltip::after {
            content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -10px;
            border-width: 10px; border-style: solid; border-color: transparent transparent #4285F4 transparent;
        }
    </style>
</head>
<body>

    <h2>ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ë¡ & í™•ì¸</h2>
    <p>ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹œíŠ¸ì™€ DBì— ì €ì¥ë©ë‹ˆë‹¤.</p>
    
    <button id="checkInBtn" onclick="getLocation()">í˜„ì¬ ìœ„ì¹˜ ì €ì¥í•˜ê¸°</button>
    <div id="status">ì¤€ë¹„ ì™„ë£Œ</div>

    <div id="result-container">
        <p>ì €ì¥ëœ ìœ„ì¹˜ (ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ë³´ì„¸ìš”):</p>
        <div style="position: relative; display: inline-block;">
            <span id="address-display" class="address-text" onmouseenter="showMap()" onmouseleave="hideMap()"></span>
            
            <div id="map-tooltip">
                <div id="map" style="width: 100%; height: 100%; border-radius: 8px;"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜… Firebase ì„¤ì • (ë³¸ì¸ ì •ë³´ë¡œ ìˆ˜ì •)
        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.saveToFirebase = function(lat, lng, address) {
            const newRef = push(ref(db, 'locations'));
            set(newRef, {
                latitude: lat,
                longitude: lng,
                address: address,
                timestamp: new Date().toLocaleString()
            }).then(() => {
                document.getElementById('status').innerText = "âœ… ëª¨ë“  ì €ì¥ ì™„ë£Œ!";
            }).catch(e => console.error(e));
        };
    </script>

    <script>
        // â˜… GAS ì›¹ ì•± URL (ë°°í¬ í›„ ë³µì‚¬í•œ ì£¼ì†Œ)
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzT2gSUo2rXDvvksuQUfB35NYe-ZTeHvGFJBbv2vOt2wcOimy0VkePTyOsGT4F0FiSo/exec";
        
        // ì§€ë„ ê´€ë ¨ ë³€ìˆ˜
        let map = null;
        let currentLat = 0;
        let currentLng = 0;

        function getLocation() {
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('checkInBtn');
            const resultContainer = document.getElementById('result-container');

            if (!navigator.geolocation) {
                statusDiv.innerText = "GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
                return;
            }

            statusDiv.innerText = "ğŸ“¡ ìœ„ì¹˜ íŒŒì•… ì¤‘...";
            btn.disabled = true;
            resultContainer.style.display = 'none'; // ì¬ì‹œë„ì‹œ ê²°ê³¼ ìˆ¨ê¹€

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    
                    statusDiv.innerText = "ğŸ”„ ì£¼ì†Œ ë³€í™˜ ë° ì‹œíŠ¸ ì €ì¥ ì¤‘...";
                    
                    // GAS í˜¸ì¶œ
                    fetch(`${GAS_SCRIPT_URL}?lat=${currentLat}&lng=${currentLng}`)
                    .then(res => res.json())
                    .then(data => {
                        if(data.result === 'success') {
                            statusDiv.innerText = "ğŸ’¾ DB ì €ì¥ ì¤‘...";
                            
                            // 1. í™”ë©´ì— ì£¼ì†Œ í‘œì‹œ
                            document.getElementById('address-display').innerText = data.address;
                            resultContainer.style.display = 'block';
                            
                            // 2. Firebase ì €ì¥
                            if(window.saveToFirebase) {
                                window.saveToFirebase(currentLat, currentLng, data.address);
                            }
                            
                            // 3. ì§€ë„ ì´ˆê¸°í™” (ë°ì´í„°ê°€ ìˆì„ ë•Œ ë¯¸ë¦¬ ì¤€ë¹„)
                            initMap(currentLat, currentLng);
                            
                        } else {
                            statusDiv.innerText = "ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
                        }
                        btn.disabled = false;
                    })
                    .catch(err => {
                        console.error(err);
                        statusDiv.innerText = "ì„œë²„ í†µì‹  ì—ëŸ¬";
                        btn.disabled = false;
                    });
                },
                (err) => {
                    statusDiv.innerText = "ìœ„ì¹˜ ê¶Œí•œ ì°¨ë‹¨ë¨: " + err.message;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }

        // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
        function initMap(lat, lng) {
            // ì´ë¯¸ ì§€ë„ê°€ ìˆìœ¼ë©´ ì¢Œí‘œë§Œ ì´ë™
            if (map) {
                map.setView([lat, lng], 16); // 16ì€ ì¤Œ ë ˆë²¨
                
                // ê¸°ì¡´ ë§ˆì»¤ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€ (ê°„ë‹¨ êµ¬í˜„ì„ ìœ„í•´)
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                L.marker([lat, lng]).addTo(map);
            } else {
                // ì§€ë„ ìµœì´ˆ ìƒì„±
                map = L.map('map', {
                    center: [lat, lng],
                    zoom: 16,
                    zoomControl: false // ì‘ì€ íŒì—…ì´ë¼ ì¤Œ ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€
                });
                
                // ì˜¤í”ˆìŠ¤íŠ¸ë¦¬íŠ¸ë§µ íƒ€ì¼ ì‚¬ìš© (ë¬´ë£Œ)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                L.marker([lat, lng]).addTo(map);
            }
        }

        // ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ
        function showMap() {
            const tooltip = document.getElementById('map-tooltip');
            tooltip.style.display = 'block';
            
            // display:none ìƒíƒœì—ì„œëŠ” ì§€ë„ ì‚¬ì´ì¦ˆ ê³„ì‚°ì´ ì•ˆë˜ë¯€ë¡œ, ë³´ì—¬ì¤€ ì§í›„ ì‚¬ì´ì¦ˆ ê°±ì‹  í•„ìš”
            if (map) {
                map.invalidateSize();
            }
        }

        // ë§ˆìš°ìŠ¤ ë—ì„ ë•Œ
        function hideMap() {
            document.getElementById('map-tooltip').style.display = 'none';
        }
    </script>
</body>
</html>
