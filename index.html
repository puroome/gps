<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ì¹˜ ì²´í¬ì¸</title>
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; text-align: center; padding: 20px; color: #333; }
        
        input {
            padding: 12px; font-size: 1.1em; width: 80%; max-width: 300px;
            margin-bottom: 20px; border: 2px solid #ddd; border-radius: 8px; text-align: center;
        }
        input:focus { border-color: #4285F4; outline: none; }

        button {
            padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 8px;
            background-color: #4285F4; color: white; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 80%; max-width: 330px;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #3367D6; }

        #status { margin: 20px 0; color: #666; font-size: 0.9em; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ“ ì¶œì„ ì²´í¬ì¸</h2>
    <p>ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    
    <input type="text" id="username" placeholder="" required>
    <br>
    
    <button id="checkInBtn" onclick="getLocation()">ì¶œì„ê¸°</bí•˜u
    <div id="status">ëŒ€ê¸° ì¤‘...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜… Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD)
        function getTodayDateString() {
            const d = new Date();
            const year = d.getFullYear();
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const day = ('0' + d.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        // 1. Firebaseì— ìš°ì„  ì €ì¥í•˜ê³  Keyë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
        window.saveToFirebase = function(lat, lng, name) {
            const newRef = push(ref(db, 'locations'));
            const data = {
                name: name,
                latitude: lat,
                longitude: lng,
                address: "ğŸ“ ì£¼ì†Œ ë³€í™˜ ì¤‘...", // ì„ì‹œ ì£¼ì†Œ
                date: getTodayDateString(), 
                timestamp: new Date().toLocaleString()
            };
            
            // ì €ì¥ í›„ í•´ë‹¹ ë°ì´í„°ì˜ Key(ID)ë¥¼ ë°˜í™˜
            return set(newRef, data).then(() => {
                return newRef.key; 
            });
        };

        // 2. ë‚˜ì¤‘ì— ì£¼ì†Œë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        window.updateFirebaseAddress = function(key, newAddress) {
            const updates = {};
            updates['/locations/' + key + '/address'] = newAddress;
            return update(ref(db), updates);
        };
    </script>

    <script>
        // â˜… GAS ì›¹ ì•± URL
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzT2gSUo2rXDvvksuQUfB35NYe-ZTeHvGFJBbv2vOt2wcOimy0VkePTyOsGT4F0FiSo/exec";
        
        function getLocation() {
            const nameInput = document.getElementById('username');
            const name = nameInput.value.trim();

            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                nameInput.focus();
                return;
            }

            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('checkInBtn');

            if (!navigator.geolocation) {
                statusDiv.innerText = "ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
                return;
            }

            statusDiv.innerText = "ì¶œì„ì„ ê¸°ë¡í•˜ëŠ” ì¤‘...";
            btn.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    try {
                        // [1ë‹¨ê³„] Firebaseì— ìš°ì„  ì €ì¥ (ì†ë„ í–¥ìƒ í•µì‹¬!)
                        statusDiv.innerText = "ğŸš€ ë°ì´í„° ì €ì¥ ì¤‘...";
                        
                        // Firebaseì— ì €ì¥í•˜ê³  ê³ ìœ  Keyë¥¼ ë°›ì•„ì˜´
                        const key = await window.saveToFirebase(lat, lng, name);
                        
                        // ì‚¬ìš©ìì—ê²ŒëŠ” ë°”ë¡œ ì„±ê³µ ë©”ì‹œì§€ ë³´ì—¬ì¤Œ (ì²´ê° ì†ë„ UP)
                        statusDiv.innerText = `âœ… ${name}ë‹˜, ì¶œì„ ì™„ë£Œ!`;
                        // ë²„íŠ¼ì€ ê³„ì† ë¹„í™œì„±í™” ìƒíƒœë¡œ ë‘ê±°ë‚˜, í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ í’€ì–´ì¤˜ë„ ë¨
                        
                        // [2ë‹¨ê³„] ë°±ê·¸ë¼ìš´ë“œì—ì„œ GAS í˜¸ì¶œ (êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ & ì£¼ì†Œ ë³€í™˜)
                        fetch(`${GAS_SCRIPT_URL}?lat=${lat}&lng=${lng}&name=${encodeURIComponent(name)}`)
                        .then(res => res.json())
                        .then(data => {
                            if(data.result === 'success') {
                                // [3ë‹¨ê³„] ë³€í™˜ëœ ì£¼ì†Œë¥¼ Firebaseì— ì—…ë°ì´íŠ¸
                                console.log("ì£¼ì†Œ ë³€í™˜ ì™„ë£Œ:", data.address);
                                if(window.updateFirebaseAddress && key) {
                                    window.updateFirebaseAddress(key, data.address);
                                    // ìµœì¢… ì™„ë£Œ ë©”ì‹œì§€
                                    statusDiv.innerText = `âœ… ${name}ë‹˜, ì¶œì„ì„ ì™„ë£Œ!`; 
                                }
                            } else {
                                console.warn("GAS ì €ì¥ ì‹¤íŒ¨:", data.error);
                            }
                        })
                        .catch(err => {
                            console.error("GAS í†µì‹  ì—ëŸ¬:", err);
                            // GASê°€ ì‹¤íŒ¨í•´ë„ Firebaseì—ëŠ” ì¢Œí‘œê°€ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ë¥¼ êµ³ì´ ë³´ì—¬ì£¼ì§€ ì•Šì•„ë„ ë¨
                        })
                        .finally(() => {
                            // ëª¨ë“  ì‘ì—…ì´ ëë‚˜ë©´ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                            btn.disabled = false;
                        });

                    } catch (e) {
                        console.error(e);
                        statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message;
                        btn.disabled = false;
                    }
                },
                (err) => {
                    statusDiv.innerText = "ìœ„ì¹˜ ê¶Œí•œ ì°¨ë‹¨ë¨: " + err.message;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true } // ì •í™•ë„ ë†’ì„
            );
        }
    </script>
</body>
</html>
