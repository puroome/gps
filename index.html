<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ì¹˜ ì²´í¬ì¸</title>
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; text-align: center; padding: 20px; color: #333; }
        
        button {
            padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 8px;
            background-color: #4285F4; color: white; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #3367D6; }

        #status { margin: 20px 0; color: #666; font-size: 0.9em; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ“ ì¶œì„/ìœ„ì¹˜ ì²´í¬ì¸</h2>
    <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜„ì¬ ìœ„ì¹˜ê°€ ì €ì¥ë©ë‹ˆë‹¤.</p>
    
    <button id="checkInBtn" onclick="getLocation()">í˜„ì¬ ìœ„ì¹˜ ì €ì¥í•˜ê¸°</button>
    <div id="status">ëŒ€ê¸° ì¤‘...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜… Firebase ì„¤ì • (ê¸°ì¡´ ì •ë³´ ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ì €ì¥ ë¡œì§)
        window.saveToFirebase = function(lat, lng, address) {
            const newRef = push(ref(db, 'locations'));
            set(newRef, {
                latitude: lat,
                longitude: lng,
                address: address,
                timestamp: new Date().toLocaleString()
            }).then(() => {
                // ì €ì¥ ì™„ë£Œ í›„ ì§€ë„ í‘œì‹œëŠ” í•˜ì§€ ì•Šê³  ë©”ì‹œì§€ë§Œ ì¶œë ¥
                document.getElementById('status').innerText = "âœ… ì €ì¥ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì°½ì„ ë‹«ìœ¼ì…”ë„ ë©ë‹ˆë‹¤)";
                document.getElementById('checkInBtn').disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™” (í•„ìš”ì‹œ)
            }).catch(e => {
                console.error(e);
                document.getElementById('status').innerText = "âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message;
            });
        };
    </script>

    <script>
        // â˜… GAS ì›¹ ì•± URL
        const GAS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzT2gSUo2rXDvvksuQUfB35NYe-ZTeHvGFJBbv2vOt2wcOimy0VkePTyOsGT4F0FiSo/exec";
        
        function getLocation() {
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('checkInBtn');

            if (!navigator.geolocation) {
                statusDiv.innerText = "GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
                return;
            }

            statusDiv.innerText = "ğŸ“¡ ìœ„ì¹˜ íŒŒì•… ì¤‘...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    statusDiv.innerText = "ğŸ”„ ì„œë²„ í†µì‹  ì¤‘...";
                    
                    // GAS í˜¸ì¶œ (ì£¼ì†Œ ë³€í™˜)
                    fetch(`${GAS_SCRIPT_URL}?lat=${lat}&lng=${lng}`)
                    .then(res => res.json())
                    .then(data => {
                        if(data.result === 'success') {
                            statusDiv.innerText = "ğŸ’¾ DB ì €ì¥ ì¤‘...";
                            
                            // Firebase ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
                            if(window.saveToFirebase) {
                                window.saveToFirebase(lat, lng, data.address);
                            }
                        } else {
                            statusDiv.innerText = "ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
                            btn.disabled = false;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        statusDiv.innerText = "ì„œë²„ í†µì‹  ì—ëŸ¬";
                        btn.disabled = false;
                    });
                },
                (err) => {
                    statusDiv.innerText = "ìœ„ì¹˜ ê¶Œí•œ ì°¨ë‹¨ë¨: " + err.message;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }
    </script>
</body>
</html>
