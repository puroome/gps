<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ì‹¤ì‹œê°„ ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; text-align: center; padding: 20px; color: #333; background-color: #f4f6f8; }
        
        .card {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: inline-block; max-width: 600px; width: 100%;
        }

        h2 { color: #d93025; margin-bottom: 5px; }
        p.sub-text { color: #666; font-size: 0.9em; margin-bottom: 30px; }

        /* ê²°ê³¼ ì£¼ì†Œ ìŠ¤íƒ€ì¼ (ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì»¤ì„œ ë³€ê²½) */
        #result-container { margin-top: 10px; }
        .address-text {
            font-size: 1.5em; font-weight: bold; color: #2c3e50;
            text-decoration: underline; text-decoration-style: dotted;
            cursor: help; position: relative; display: inline-block;
            padding: 5px;
        }
        .time-text { color: #888; margin-top: 10px; font-size: 0.9em; }

        /* íŒì—… ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map-tooltip {
            display: none;
            position: absolute;
            width: 350px; height: 250px;
            top: 100%; left: 50%;
            transform: translateX(-50%);
            border: 2px solid #4285F4; border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            margin-top: 15px;
            background: white;
        }
        
        /* íˆ´íŒ í™”ì‚´í‘œ */
        #map-tooltip::after {
            content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -10px;
            border-width: 10px; border-style: solid; border-color: transparent transparent #4285F4 transparent;
        }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë‹ˆí„°ë§</h2>
        <p class="sub-text">ê°€ì¥ ìµœê·¼ì— ì €ì¥ëœ ìœ„ì¹˜ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>

        <div id="result-container">
            <p>ìµœê·¼ ì €ì¥ ìœ„ì¹˜ (ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ë³´ì„¸ìš”):</p>
            
            <div style="position: relative; display: inline-block;">
                <span id="address-display" class="address-text" onmouseenter="showMap()" onmouseleave="hideMap()">
                    ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
                </span>
                
                <div id="map-tooltip">
                    <div id="map" style="width: 100%; height: 100%; border-radius: 8px;"></div>
                </div>
            </div>
            
            <div id="timestamp-display" class="time-text">-</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-qu7Z0v_ygNbiKzT7tt6Byigp_AGcdPo",
            authDomain: "gps1-cf085.firebaseapp.com",
            databaseURL: "https://gps1-cf085-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gps1-cf085",
            storageBucket: "gps1-cf085.firebasestorage.app",
            messagingSenderId: "407130432420",
            appId: "1:407130432420:web:2f78b17a891bce1e6cd731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // â˜… Firebaseì—ì„œ ê°€ì¥ ìµœê·¼ ë°ì´í„° 1ê°œë§Œ ê³„ì† ê°ì‹œ(Listen)
        const lastLocationQuery = query(ref(db, 'locations'), limitToLast(1));

        onValue(lastLocationQuery, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // ë°ì´í„°ëŠ” ê°ì²´ í˜•íƒœ(key: value)ë¡œ ì˜¤ë¯€ë¡œ ê°’ì„ ì¶”ì¶œ
                const keys = Object.keys(data);
                const lastRecord = data[keys[0]];

                updateDashboard(lastRecord);
            }
        });

        // í™”ë©´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDashboard(record) {
            document.getElementById('address-display').innerText = record.address;
            document.getElementById('timestamp-display').innerText = "ì €ì¥ ì¼ì‹œ: " + record.timestamp;

            // ì „ì—­ ë³€ìˆ˜ì— ì¢Œí‘œ ì €ì¥ (ì§€ë„ê°€ ì“¸ ìˆ˜ ìˆê²Œ)
            window.targetLat = record.latitude;
            window.targetLng = record.longitude;
        }
    </script>

    <script>
        // ì§€ë„ ê´€ë ¨ ë³€ìˆ˜
        let map = null;
        // window.targetLat / Lng ëŠ” ìœ„ì˜ ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.

        // ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ
        function showMap() {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
            if (!window.targetLat || !window.targetLng) return;

            const tooltip = document.getElementById('map-tooltip');
            tooltip.style.display = 'block';
            
            // ì§€ë„ ì´ˆê¸°í™” ë˜ëŠ” ì´ë™
            initMap(window.targetLat, window.targetLng);
            
            // ì§€ë„ ì‚¬ì´ì¦ˆ ì¬ì¡°ì • (display:none í•´ì œ ì§í›„ í•„ìˆ˜)
            if (map) {
                setTimeout(() => map.invalidateSize(), 10);
            }
        }

        // ë§ˆìš°ìŠ¤ ë—ì„ ë•Œ
        function hideMap() {
            document.getElementById('map-tooltip').style.display = 'none';
        }

        // ì§€ë„ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function initMap(lat, lng) {
            if (map) {
                map.setView([lat, lng], 16);
                
                // ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                L.marker([lat, lng]).addTo(map);
            } else {
                map = L.map('map', {
                    center: [lat, lng],
                    zoom: 16,
                    zoomControl: false
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                L.marker([lat, lng]).addTo(map);
            }
        }
    </script>
</body>
</html>
